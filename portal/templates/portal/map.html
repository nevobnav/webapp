{% extends "portal/base.html" %}
{% load static %}


{% block header %}
  <!-- Loading a lot of crap -->
  <!-- responsive tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Leaflet itself -->
  <script src="{% static "portal/js/leaflet.js" %}" ></script>
  <link rel="stylesheet" href="{% static "portal/css/leaflet.css" %}" >

  <!-- Jquery -->
  <script src="{% static "portal/js/jquery-3.3.1.min.js" %}"></script>
  <script src="{% static "portal/js/jquery-1.9.1.min.js" %}"></script>
  <script src="{% static "portal/js/jquery-ui.js" %} "></script>
  <link rel="stylesheet" href="{% static "portal/css/jquery-ui.css" %}" />

  <!-- Legend -->
  <link rel="stylesheet" href="{% static "portal/css/layers_legend_box.css" %}" />

  <!-- Time Slider -->
  <script src="{% static "portal/js/SliderControl.js" %}" type="text/javascript"></script>

  <!-- Locate button -->
  <script src="{% static "portal/js/L.Control.Locate.min.js" %}" ></script>
  <script src="{% static "portal/js/L.Control.Locate.min.js.map" %}"></script>
  <link rel="stylesheet" href="{% static "portal/css/L.Control.Locate.css" %}">
  <link rel="stylesheet" href="{% static "portal/css/L.Control.Locate.min.css" %}">
  <link rel="stylesheet" href="{% static "portal/css/L.Control.Locate.min.css.map" %}">

  <!-- Heat map -->
  <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.Default.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/leaflet.markercluster.js"></script>


  <!-- creating script sources based on user ID-->
  <script>
  var username = "{{ user.username }}"
    var plotname = "{{ plot.name }}"
    var basic_data_path = "{{ MEDIA_URL }}/data/"
  </script>

{% endblock %}

{% block content %}

  <div id='map' class="map"></div>

  <script>

    var lat = {{ plot.shape.centroid.y }}
    var lon = {{ plot.shape.centroid.x }}
    var center_coords = [lat, lon]

    // initalize slider control
    var sliderControl = null;

    // create an empty map and base map
    var map = L.map('map', {
      center: center_coords,
      zoom: 17,
      crs: L.CRS.EPSG3857,
    });

    var base_sat =  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      // maxZoom: 18,
      id: 'mapbox.satellite',
      accessToken: 'pk.eyJ1IjoiYm5vb3RlYm9zIiwiYSI6ImNqcXA3ZHAzODBtbWM0MnBzZm5vbGRndmUifQ.H2zjIsYA5P2SFxZlSBIYjA',
      time: "2013-01-22 8:42:26+01",
      maxZoom:23
    }).addTo(map);


    // LAYERS
    var scan_list = []
    {% for scan in scans %}
      var scan_path = basic_data_path + username+ "/" + plotname + "/scans/" + scan_date + "/{z}/{x}/{y}.png"
      var scan_path =  + scan_date + "/{z}/{x}/{y}.png"

      var customer_scan_{{ scan.date|date:"Ymd" }} =  L.tileLayer(scan_path, {
        minZoom: 15,
        maxZoom: 23,
        tms: true,
        time: "{{scan.date }}"
      });
      scan_list.push(customer_scan_{{ scan.date|date:"Ymd" }})

    {% endfor %}

      // GROUP LAYERS


    // TIME SLIDER
    layerGroup = L.layerGroup(scan_list);
    var sliderControl = L.control.sliderControl({position: "topright", layer:layerGroup, no_of_layers:scan_list.length, alwaysShowDate:false});
    map.addControl(sliderControl);
    sliderControl.startSlider();

  </script>

{% endblock %}
