{% extends "portal/base.html" %}
{% load static %}
{% load i18n %}


{% block header %}


  <!-- Loading a lot of crap -->
  <!-- responsive tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Leaflet itself -->
  <script src="{% static "portal/js/leaflet.js" %}" ></script>
  <link rel="stylesheet" href="{% static "portal/css/leaflet.css" %}" >

  <!-- Jquery -->
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <!-- //<script src="{% static "portal/js/jquery-3.3.1.min.js" %}"></script>
  //<script src="{% static "portal/js/jquery-1.9.1.min.js" %}"></script>
  //<script src="{% static "portal/js/jquery-ui.js" %} "></script> -->
  <link rel="stylesheet" href="{% static "portal/css/jquery-ui.css" %}" />

  <!-- Legend -->
  <link rel="stylesheet" href="{% static "portal/css/layers_legend_box.css" %}" />

  <!-- leaflet Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.2/dist/leaflet.draw-src.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.2/dist/leaflet.draw-src.js"></script>
  <script src="{% static "portal/js/leaflet-measure-path.js" %} "></script>
  <link rel="stylesheet" href="{% static "portal/css/leaflet-measure-path.css" %}" />

  <!-- nlMaps -->
  <script src="https://rawgit.com/geo-frontend/nlmaps/master/dist/nlmaps.iife.js"></script>

  <!-- Time Slider -->
  <script src="{% static "portal/js/SliderControl.js" %}" type="text/javascript"></script>

  <!-- Heat map -->
  <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- EasyButton -->
  <script src="{% static "portal/js/L.EasyButton.js" %} "></script>
  <link rel="stylesheet" href="{% static "portal/css/L.EasyButton.css" %}" />

  <!-- GroupedLayers -->
  <script src="{% static "portal/js/L.GroupedLayerControl.js" %} "></script>
  <link rel="stylesheet" href="{% static "portal/css/L.GroupedLayerControl.css" %}" />


  <!-- fontawesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">




  <!-- creating script sources based on user ID-->
  <script>
    var username = "{{ user.username }}"
    var customer_name = "{{ this_parent_plot.customer.customer_name }}"
    var plotname = "{{ this_parent_plot.name }}"
    var basic_data_path = "{{ MEDIA_URL }}data/"
  </script>

{% endblock %}

{% block content %}

  <div id='map' class="map"></div>

  <script>

    var lat = {{ this_plot.shape.centroid.y }}
    var lon = {{ this_plot.shape.centroid.x }}
    var center_coords = [lat, lon]
    var init_zoom = 17
    var max_zoom = 24

    // initalize slider control
    var sliderControl = null;

    // create an empty map and base map
    var map = L.map('map', {
      center: center_coords,
      zoom: init_zoom,
      crs: L.CRS.EPSG3857,
    });

    // Scale bar
    var scalecontrol = L.control.scale({
      imperial: false
    }).addTo(map);

    var base_sat =  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
      id: 'mapbox.streets-satellite',
      accessToken: 'pk.eyJ1IjoiYm5vb3RlYm9zIiwiYSI6ImNqcXA3ZHAzODBtbWM0MnBzZm5vbGRndmUifQ.H2zjIsYA5P2SFxZlSBIYjA',
      maxZoom:max_zoom,
    });

    var aerialRGB = L.tileLayer.wms("https://geodata.nationaalgeoregister.nl/luchtfoto/rgb/wms?", {
    layers: 'Actueel_ortho25',
    format:'image/png',
    transparent: true,
    tile:true,
    maxZoom:max_zoom,
    });
    aerialRGB.addTo(map);


    {% if user.is_staff %}
      var dronezones = L.tileLayer.wms("https://geodata.nationaalgeoregister.nl/dronenoflyzones/wms?", {
      layers: 'luchtvaartgebieden_zonder_natura2000',
      format:'image/png',
      transparent: true,
      tile:true,
      maxZoom:max_zoom,
      });
    {% endif %}


    // LAYERS
    var scan_list = []
    let scan_info;
    var scan_flight_altitude = ''
    scan_id = ''
    {% for scan in scans %}
      {% if scan.live %}
        var scan_date = {{ scan.date|date:"Ymd" }}
        var scan_time = '{{ scan.time|date:"Hi" }}'
        var scan_path = basic_data_path + customer_name + "/" + plotname + "/" + scan_date + scan_time + "/{z}/{x}/{y}.png"
        var scan_max_zoom = {{ scan.zoomlevel }} + 1;   //Increase zoom level by 1 to include a pixel-zoom
        var scan_max_native_zoom = {{ scan.zoomlevel }};
        var scan_flight_altitude = {{ scan.flight_altitude }};
        var scan_id = {{ scan.id }}
        var customer_scan_{{ scan.date|date:"Ymd" }} =  L.tileLayer(scan_path, {
          minZoom: 15,
          maxZoom: scan_max_zoom,
          maxNativeZoom: scan_max_native_zoom,
          tms: true,
          time: "{{scan.date }}",
          // pass along extra info from database
          infobox_context: [scan_flight_altitude, scan_id], // extra properties can be added in this array

        });

        // Setting language to Dutch to format date
        {% language 'nl' %}

        // Create new layer and give title. Remove time if its 02:00 (which means no
        // time is available)

          {% if scan.time|date:"Hi" == '0200' %}
            var new_entry = {"{{ scan.date|date:"j E" }}":
                              customer_scan_{{ scan.date|date:"Ymd" }}};
          {% else %}
            var new_entry = {"{{ scan.date|date:"j E" }} - {{ scan.time|date:"H:i" }}":
                              customer_scan_{{ scan.date|date:"Ymd" }}};
          {% endif %}

        {% endlanguage %}

        // Add this layer to the list of scan layers
        var scan_list = $.extend(scan_list, new_entry);

        {% if forloop.last %}
          customer_scan_{{ scan.date|date:"Ymd" }}.addTo(map);
        {% endif %}
      {% endif %}
    {% endfor %}
    scan_info = [scan_flight_altitude, scan_id];

    //Import shape from DB
    var latlongs = {{ latlong }};

    // Show gif instead of tiles when no scans are available
    {% if scans %}
    var plotshape = L.polygon(latlongs, {fillOpacity: 0.0, color: 'red'});
    {% else %}
      var plotshape = L.polygon(latlongs, {fill: 'red', fillOpacity: 0.3, color: 'red'});
      plotshape.bindPopup("Nog geen dronebeelden beschikbaar.",{'fontFamily':'Roboto Condensed'});
        plotshape.on('mouseover', function (e) {
            this.openPopup();
        });
        plotshape.on('mouseout', function (e) {
            this.closePopup();
        });
    {% endif %}

    var plotlayer = L.layerGroup([plotshape]).addTo(map);

    // var aerial = nlmaps.leaflet.bgLayer('luchtfoto')


    // My draw Toolbar

    // hack to disable adding points while dragging the map (touch and mouse)

    (function() {
    var originalOnTouch = L.Draw.Polyline.prototype._onTouch;
    L.Draw.Polyline.prototype._onTouch = function( e ) {
      if( e.originalEvent.pointerType != 'mouse'  && e.originalEvent.pointerType != 'touch' ) {
        return originalOnTouch.call(this, e);
    }
    }
    })();

    var drawnItems = new L.FeatureGroup()
    map.addLayer(drawnItems)
    var drawControl = new L.Control.Draw({
      draw:{polyline: {shapeOptions: {showMeasurements: {showOnHover: true}}},
            polygon: false,
            marker: false,
            circlemarker: false,
            rectangle: false,
            circle: false,
        },
      edit: {
        featureGroup: drawnItems,
        edit: false
      }
    });

    map.addControl(drawControl);
    map.on(L.Draw.Event.CREATED, function (e) {
       var layer = e.layer;
       drawnItems.addLayer(layer);
    });

    // SETTING BASEMAPS AND OVERLAYMAPS
    var baseMaps = {"Luchtfoto's":aerialRGB ,"Satelliet":base_sat};

    var overlayMaps = {
      "Dronebeelden": scan_list,
      "Extra's": {
        {% if user.is_staff %}
        "No-Fly":dronezones
        {% endif %}
      }
    };

    // LAYER CONTROL
    L.control.groupedLayers(baseMaps, overlayMaps,{collapsed:false, exclusiveGroups:['Dronebeelden']}).addTo(map);
    L.easyButton('fa-vector-square',function(btn,map){
      map.setView([lat, lon], init_zoom);
    },'Terug naar perceel').addTo(map);

    {% if mapnotes %}
    L.easyButton('fa-map-marker-alt', function(){

      if (map.hasLayer(markerGroup)){
        map.removeLayer(markerGroup)
      } else {
        map.addLayer(markerGroup)
      };
    },
    'Verberg opmerkingen').addTo(map);
    {% endif %}

    // ADD NEW MAPNOTE
    {% if user.is_staff %}
      L.easyButton('fa-comment', function(){
        addMapNote()
      },'Voeg notitie toe').addTo(map);


      function addMapNote(){
        //map.on('click', function(e) {

          // var MapNote = L.popup();
          var marker = L.marker([lat, lon],{draggable:'true'}).addTo(map);

          {% spaceless %}
            //var content = `<form id=${form_id} method="post"> {% csrf_token %}  {{form.as_p}} <br><button class="submit_btn" type="submit"> Save</button>`
            var content = `<form id="note_form" method="post"> {% csrf_token %}  {{form.as_p}} <br><button class="submit_btn" type="submit"> Save</button>`

          {% endspaceless %}

          marker.bindPopup(content);

          // MapNote.setContent(content);
          // MapNote.setLatLng(e.latlng); //calculated based on the e.layertype
          // MapNote.openOn(map);

          $('body').on('submit', '#note_form', function(A) {
            A.preventDefault()
            $.ajax({
              url: '/portal/ajax/add_note/',
              data: {
                    name: $('#id_name').val(),
                    note: $('#id_note').val(),
                    lat: marker.getLatLng().lat,
                    lon: marker.getLatLng().lng,
                    scan_id: scan_info[1]
                  },
              dataType: 'json',
            })
            console.log( 'endofquery' );
            marker.closePopup()
            // MapNote.remove();
          })
        //});
      };
    {% endif %}


      // SHOWING MAP NOTES
      var markerGroup = L.layerGroup().addTo(map);
      function drawMarkers(input_data){
        markerGroup.clearLayers()
        console.log('Scan info equals')
        console.log(input_data[1])

        {% for note in mapnotes %}
          var name_note = '{{note.name}}'
          var note = '{{note.note|striptags}}'
          var note_scan = {{note.scan_id}}

          if (note_scan == input_data[1]) {
            marker = L.marker([{{note.lat}}, {{note.lon}}]).addTo(markerGroup);
            {% language 'nl' %}
            {% spaceless %}
              var content = '<h6>{{note.name}}</h6>\
              <span class="text-muted"><i> ({{note.time |date:"j E 'y - H:i"}} )</i></span>  <br>\
              <span class="text-secondary"> {{note.note|striptags}}</span>';
            {% endspaceless %}
            {% endlanguage %}
            marker.bindPopup(content)
          }
        {% endfor %}
      };


    // WIDGET SHOWING SCAN INFO

    var info = L.control({position: 'bottomright'});

    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        this.update();
        return this._div;
    };

    // function used to update 'infobox' content based on current layer clicked
    info.update = function (infobox_context) {
      this._div.innerHTML = (infobox_context ?
          '<b> Vlieghoogte: </b>' + infobox_context[0] + ' m'
          : '-');
      scan_info = infobox_context
    };


    info.addTo(map);
    info.update([scan_flight_altitude, scan_id]);  // on map creation, infobox content is pulled manually. LELIJK - fixen als er meer info in infobox_context komt!
    drawMarkers([scan_flight_altitude, scan_id])
    // when a different layer is selected, the function 'onOverlayAdd' is fired
    map.on('overlayadd', onOverlayAdd);

    // function to push infobox_content to infobox
    function onOverlayAdd(currentlayer){
      info.update(currentlayer.layer.options.infobox_context);
      drawMarkers(currentlayer.layer.options.infobox_context);

    }


  </script>


{% endblock %}
